pipeline {
  agent { label 'master' }
  environment {
    feContainer = "client-test"
    beContainer = "api-test"
  }

  stages {
    stage('Checkout') {
      steps {
        deleteDir()
        checkout scm
      }
    }

    stage("Build") {
      parallel {
        stage("Front end") {
          steps {
            sh "docker build . -t ${feContainer} -f jenkins-ci/Dockerfile.front"
          }
        }

        stage("Back end") {
          steps {
            sh "docker build . -t ${beContainer} -f jenkins-ci/Dockerfile.back"
          }
        }
      }
    }

    stage("Tests") {
      parallel {
        stage("Front end") {
           steps {
            sh "docker run --rm ${feContainer}"
          }

          post {
            always {
              sh "docker rmi ${feContainer}"
            }
          }
        }
        
        stage("Back end") {
          steps {
            sh "docker run --rm ${beContainer}"
          }

          post {
            always {
              sh "docker rmi ${beContainer}"
            }
          }
        }
      }
    }
  }
}